[TOC]

即登录到sentinel节点后执行的命令，比如执行"redis-cli -h sentinel_ip -p26379"命令后，才可以执行下面命令
# ping：返回pong
```
ping
```
# masters：列出所有被监视的主服务器，以及这些主服务器的当前状态
```
SENTINEL masters
```
# slaves：列出给定主服务器的所有从服务器，以及这些从服务器的当前状态
```
SENTINEL slaves <mastername>
```
# get-master-addr-by-name：返回给定名字的主服务器的 IP 地址和端口号
如果这个主服务器正在执行故障转移操作， 或者针对这个主服务器的故障转移操作已经完成， 那么这个命令返回新的主服务器的 IP 地址和端口号
```
SENTINEL get-master-addr-by-name <master name>
```
# reset：重置所有名字和给定模式pattern相匹配的主服务器
pattern 参数是一个Glob风格的模式。 重置操作清楚主服务器目前的所有状态， 包括正在执行中的故障转移， 并移除目前已经发现和关联的， 主服务器的所有从服务器和Sentinel
```
SENTINEL reset <pattern>
```
# failover：当主服务器失效时， 在不询问其他 Sentinel 意见的情况下， 强制开始一次自动故障迁移
发起故障转移的Sentinel会向其他Sentinel发送一个新的配置，其他Sentinel会根据这个配置进行相应的更新
```
SENTINEL failover <master name>
```
# monitor：这个命令告诉sentinel去监听一个新的master
```
SENTINEL monitor <name> <ip> <port> <quorum>
```
# remove：命令sentinel放弃对某个master的监听
```
SENTINEL remove <name>
```
# set：这个命令很像Redis的CONFIG SET命令，用来改变指定master的配置。支持多个[option:value]
只要是配置文件中存在的配置项，都可以用SENTINEL SET命令来设置。这个还可以用来设置master的属性，比如说quorum(票数)，而不需要先删除master，再重新添加master
```
SENTINEL set <name> <option> <value>
SENTINEL SET objects-cache-master down-after-milliseconds 1000
```
# get-master-addr-by-name：获取当前的主服务器IP地址和端口号
```
SENTINEL get-master-addr-by-name <master name>
```
# slaves：获取所有的Slaves信息
```
SENTINEL slaves <master name>
```

---

# Demo
## sentinel主要配置
```config
port ${port}
daemonize yes
dir "/opt/soft/redis/data/"
logfile "${port}.log"
# 主节点名字，ip，端口，几个sentinel发现master有问题发生故障转移
sentinel monitor mymaster 127.0.0.1 7000 2
# 30000ms ping不通确认有问题
sentinel down-after-milliseconds mymaster 30000
# 一次复制一个
sentinel parallel-syncs mymaster 1
#
sentinel failover-timeout mymaster 180000
```
## Reids主/从节点

主节点：
```config
port 7000
daemonize yes
pidfile /var/run/redis-7000.pid
logfile "7000.log"
dir "/opt/soft/redis/data/7000/"
```

从节点1：
```config
port 7001
daemonize yes
pidfile /var/run/redis-7001.pid
logfile "7001.log"
dir "/opt/soft/redis/data/7001/"
slavof 127.0.0.1 7000
```

从节点2：
```config
port 7002
daemonize yes
pidfile /var/run/redis-7002.pid
logfile "7002.log"
dir "/opt/soft/redis/data/7002/"
slavof 127.0.0.1 7000
```

技巧：
```config
sed "s/7000/7001/g" redis-7000.conf > redis-7001.conf
sed "s/7000/7002/g" redis-7000.conf > redis-7002.conf
echo "slaveof 127.0.0.1 7000" >> redis-7001.conf
echo "slaveof 127.0.0.1 7000" >> redis-7002.conf
ps -ef | grep redis-server | grep 700
```
## 安装sentinel
```config
cat sentinel.conf | grep -v "#" | grep -v "^$" > redis-sentinel-26379.conf
redis-sentinel redis-sentinel-26379.conf
ping
info
```
sentinel的配置会被重写：
```
# Generated by CONFIG REWRITE
sentinel know-slave mymaster 127.0.0.1 7001
sentinel know-slave mymaster 127.0.0.1 7002
sentinel current-epoch 0
还有部分配置被去掉了
```
多sentinel配置：
```
sed "s/26379/26380/g" redis-sentinel-26379.conf > redis-sentinel-26380.conf
sed "s/26379/26381/g" redis-sentinel-26379.conf > redis-sentinel-26381.conf
```

# 启动
redis-sentinel *.conf