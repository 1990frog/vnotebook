vnote_backup_file_826537664 /home/cai/Documents/vnotebook/programs/language/java/core/concurrent/JUC/各种锁.md
[TOC]

# Lock接口
+ 锁是一种工具，用于控制对共享资源的访问
+ Lock和synchronized，这两个是最常见的锁，它们都可以达到线程安全的目的，但是在使用上和功能上又有较大的不同。
+ Lock并不是用来代替synchronized的，而是当使用synchronized不适合或不足以满足要求的时候，来提供高级功能的。
+ Lock接口最常见的实现类是ReentrantLock
+ 通常情况下，Lock只允许一个线程来访问这个共享资源。不过有的时候，一些特殊的实现也允许并发访问，比如：ReadWriteLock里面的ReadLock

# synchronized不够用？
1. 效率低：锁释放情况少、试图获得锁时不能设定超时、不能中断一个正在试图获得锁的线程
2. 不够灵活（读写锁更灵活）：加锁和释放的时机单一，每个锁仅有单一的条件（某个对象），可能是不够的
3. 无法知道是否成功获取到锁

# Lock主要方法介绍
## lock()
1. lock()就是最普通的获取锁。如果锁已被其他线程获取，则进行等待
2. Lock不会像synchronized一样在异常时自动释放锁
3. 因此最佳实践是，在finally中释放锁，以保证发生异常时锁一定被释放
4. lock()方法不能被中断，这会带来很大的隐患：一旦陷入死锁，lock()就会陷入永久等待
## tryLock()
1. tryLock()用来尝试获取锁，如果当前锁没有被其他线程占用，则获取成功，则返回true，否则返回false，代表获取锁失败
2. 相比于lock，这样的方法显然功能更强大了，我们可以根据是否能获取锁来决定后续程序的行为
3. 该方法会立即返回，即便在拿不到锁时不会一直在那等
## tryLock(long time,TimeUnit unit)
超时就放弃
## lockInterruptibly()
相当于tryLock(long time,TimeUnit unit)把超时时间设置为无限。在等待锁的过程中，线程就可以被中断
## unlock()
先解锁再写业务逻辑

# 可见性保证
happens-before
Lock的加解锁和synchronized有同样的内存语义，也就是说，下一个加锁前可以看到所有前一个解锁后发生的所有语句
![](_v_images/20200108205936127_1842023762.png)


# 锁的分类
+ 这些分类，是从各种不同角度出发去看的
+ 这些分类并不是互斥的，也就是多个类型可以并存：有可能一个锁，同时属性两种类型
+ ReentrantLock既是互斥锁，又是可重入锁
+ 好比一个人可以同时是男人，又是军人，这个不冲突

![](_v_images/20200109225519622_1772839565.png)

# 乐观锁与悲观锁
![](_v_images/20200109225831174_666100278.png)

![](_v_images/20200109230020194_2139001200.png)

![](_v_images/20200109230045226_233697470.png)

![](_v_images/20200109230102633_923642577.png)

![](_v_images/20200109230239425_969223664.png)

![](_v_images/20200109230322328_1228433074.png)

![](_v_images/20200109230334071_748986305.png)

![](_v_images/20200109230351904_791186771.png)

![](_v_images/20200109230403391_602653250.png)

![](_v_images/20200109230508095_1771185892.png)


![](_v_images/20200109230828564_1032722592.png)

![](_v_images/20200109230927595_1368620277.png)

![](_v_images/20200109231022506_1032533014.png)


![](_v_images/20200109231114025_1501055170.png)

![](_v_images/20200109231250600_1132676675.png)

![](_v_images/20200109231322896_1778517775.png)

![](_v_images/20200109231347864_1573972334.png)

# 可重入锁与非可重入锁

![](_v_images/20200109231502319_295214440.png)

电影院买票选座位

![](_v_images/20200109231626141_1043388258.png)

![](_v_images/20200109231713197_1692052357.png)

![](_v_images/20200109231728454_887079299.png)

![](_v_images/20200109231759605_1768144880.png)