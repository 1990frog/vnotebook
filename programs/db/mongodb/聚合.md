[TOC]

# 聚合操作
+ 单一用途的聚合方法
+ Map Reduce
+ 聚合管道 `db.collection.aggregate()`

# 聚合表达式
+ 用来操作输入文档的“公式”
+ 经聚合表达式计算出的值可以被赋予输出文档中的字段
+ 字段路径，系统变量，文本，表达式对象，操作符

# 聚合阶段
+ 聚合阶段有顺序地排列在聚合管道中
+ 绝大多数聚合阶段可以反复出现（$out和\$geoNear除外）
+ 数据库层面和集合层面

# 聚合操作符
`db.<collection>.aggregate(<pipeline>,<options>)`
<pipeline>文档定义了操作中使用的聚合管道阶段和聚合操作符
<options>文档声明了一些聚合操作的参数

字段路径表达式
$<field> - 使用\$来指示字段路径
$<field>.<sub-field> - 使用\$和.来指示内嵌文档字段路径

系统变量表达式
$$<variable> - 使用$$来指示系统变量
$$CURRENT - 指示管道中当前操作的文档
$$CURRENT.<field>和$<field>是等效的

常量表达式
$literal:<value> - 指示常量<value>
$literal:"\$name" - 指示常量字符串"\$name"

# 聚合管道阶段
$project 对输入文档进行再次投影
$match 对输入文档进行筛选
$limit 筛选出管道内前n篇文档
$skip 跳过管道内前n篇文档
$unwind 展开输入文档中的数组字段
$sort 对输入文档进行排序
$lookup 对输入文档进行查询操作
$group 对输入文档进行分组
$out 将管道中的文档输出