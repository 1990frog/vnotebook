[TOC]

# 搜索原理
+ 独立的网络上的一个或一组进程节点
+ 对外提供搜索服务（http或transport协议【逐步废弃】）
+ 对内就是一个搜索数据库

# 名词定义
+ 索引=数据库
+ 类型(废弃ing)=表
+ 文档=行数据

# ES对比关系型数据库
|   Relational database   | Elasticsearch  |
| ---------------------- | ------------- |
| Table                  | Index(名词)     |
| Row                    | Document       |
| Column                 | Field          |
| Schema                 | Mapping        |
| SQL                    | Query DSL      |

传统关系型数据库和Elasticsearch的区别：
Elasticsearch：schemaless、相关性、高性能全文索引
RDMS：事务性、join

# 索引
+ 搜索中的数据库或表定义
+ 构建文档时候的索引创建

例子：
书的目录——正排索引
书的索引（关键词）——倒排索引

# 分词
+ 搜索是以词为单位做最基本的搜索单元
+ 依靠分词器构建分词
+ 用分词构建倒排索引

# 正向索引
{xiaoming is chinese}-->{xiaoming},{is},{chinese}
...
[doc]->[word]

# 倒排索引
{xiaoming}-->{}-->{}
{is}-->{}-->{}
{chinese}-->{}-->{}
...
[word]->[doc]

倒排索引是搜索引擎的核心，注意包含两部分：
+ 单词词典（Term Dictionary）
+ 倒排列表（Posting List）

posting包含：
+ 文档id
+ 单词频率（TF）
+ 位置，记录单词在文档中的分词位置（多个），用于做词语搜索（Phrase Query）
+ 偏移，记录单词在文档的开始和结束位置，用于做高亮显示

# 启动
```
$ elasticsearch
```

# 查看启动成功
```
http://localhost:9200/_cat

=^.^=
/_cat/allocation
/_cat/shards
/_cat/shards/{index}
/_cat/master
/_cat/nodes
/_cat/tasks
/_cat/indices
/_cat/indices/{index}
/_cat/segments
/_cat/segments/{index}
/_cat/count
/_cat/count/{index}
/_cat/recovery
/_cat/recovery/{index}
/_cat/health
/_cat/pending_tasks
/_cat/aliases
/_cat/aliases/{alias}
/_cat/thread_pool
/_cat/thread_pool/{thread_pools}
/_cat/plugins
/_cat/fielddata
/_cat/fielddata/{fields}
/_cat/nodeattrs
/_cat/repositories
/_cat/snapshots/{repository}
/_cat/templates
```
查看es健康
```
http://localhost:9200/_cat/health

1583670106 12:21:46 elasticsearch green 1 1 3 3 0 0 0 0 - 100.0%
```

# 文档（Document）
+ Elasticsearch是面向文档的，文档是所有可搜索数据的最小单位
+ 文档会被序列化成json格式，保存在Elasticsearch中
+ 每个文档都有一个unique id

# 文档元数据
+ _index：文档所属的索引名
+ _type：文档所属的类型名
+ _id：文档唯一id
+ _source：文档原始json数据
+ _all：整合所有字段内容到该字段，已被废除（可以用copy_to）
+ _version：文档的版本信息
+ _score：相关性打分

# 索引
index是文档的容器，是一类文档的结合
+ index体现了逻辑空间的概念：每个索引都有自己的mapping定义，用于定义包含的文档的字段名和字段类型
+ shard体现了物理空间的概念：索引中的数据分散在shared上

索引的mapping和settings
+ mapping定义文档字段的类型
+ settings定义不同的数据分布

# 索引的不同语义
+ 名词：一个Elasticsearch集群中，可以创建很多个不同的索引
+ 动词：保存一个文档到Elasticsearch的过程也叫索引（indexing）


# type
在7.0之前，一个index可以设置多个types，6.0开始，type已经被废弃了。7.0开始，一个索引只能创建一个type：”_doc“


# Node
## Data Node
可以保存数据的节点，叫做data node。负责保存分片数据。在数据扩展上起到了至关重要的作用
## Coordinating Node
+ 负责接受client的请求，将请求分发到合适的节点，最终把结果汇集到一起
+ 每个节点默认都起到了Coordinating Node的职责






---

# 文档的CRUD
| 关键字  |                    语法                     |
| ------ | ------------------------------------------ |
| index  | PUT index/_doc/1 {}                         |
| create | PUT index/_doc/1 {}</br>POST index/_doc/1 {} |
| read   | GET index/_doc/1                            |
| update | POST index/_update/1 {}                     |
| delete | DELETE index/_doc/1                         |

+ type名，约定都有_doc（7.0开始所有的type都用_doc来指定）
+ create，如果id已经存在，会失败
+ index，如果id不存在，创建新的文档。否则，先删除现有的文档，再创建新的文档，版本会增加

# Update文档
+ update方法不会删除原来的文档，而是实现真正的数据更新
+ post方法/payload需要包含在”doc“中

```json
post index/_update/1
{
    "doc":{
        "field":"value"
    }
}
```



# elasticsearch的倒排索引
+ elasticsearch的json文档中的每个字段，都有自己的倒排索引
+ 可以指定对某些字段不做索引
    + 优点：节省存储空间
    + 缺点：字段服务被搜索


# 指定查询的索引
|          语法          |      范围       |
| --------------------- | -------------- |
| /_search               | 集群上所有的索引   |
| /index1/_search        | index1          |
| /index1,index2/_search | index1,index2   |
| /index*/_search        | 以index开头的索引 |



# Query String Syntax
布尔操作
AND,OR,NOT或者&&,||,!
分组
+表示must
-表示must_not
范围查询
区间表示：
[]闭区间
{}开区间
算数符号
year:>2010
year:(>2010&&<=2018)

# _source filtering 指定查询字段
+ 如果_source没有存储，那就只返回匹配的文档的元数据
+ _source支持使用通配符`_source["name*"]`
```json
GET index/_search
{
    "_source":["key1","key2"]
}
```

# 脚本字段
用例：订单中有不同的汇率，需要结合汇率对订单价格进行
```json
GET index/_search
{
    "script_fields":{
        "new_field":{
            "script":{
                "lang":"painless",
                "source":"doc['order_date'].value+'hello'"
            }
        }
    },
    "from":10,
    "size":5,
    "query":{
        "match_all":{}
    }
}
```




