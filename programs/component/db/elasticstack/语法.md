[TOC]

# 新建索引
## 非结构化方式新建索引(no mapping)
### 新增
```
PUT /city/_doc/1
{
  "code":"10001",
  "value":"成都"
}
PUT /city/_doc/2
{
  "code":"10002",
  "value":"乐山"
}
PUT /city/_doc/3
{
  "code":"10003",
  "value":"广州",
  "weather":"bad"
}
```
强制创建，如果数据存在，则报错
```
POST /city/_create/3
{
  "code":"10000",
  "value":"广州",
  "weather":"bad"
}
```
相同字段插入不同类型，然而并不报错
```
PUT /city/_doc/2
{
  "code":"10002",
  "value":"乐山"
}
PUT /city/_doc/5
{
  "code":"华山",
  "value":"华山"
}
```
### 查询
```
GET /city/_doc/1
{

}

result：
{
  "_index" : "city",
  "_type" : "_doc",
  "_id" : "1",
  "_version" : 1,
  "_seq_no" : 0,
  "_primary_term" : 1,
  "found" : true,
  "_source" : {
    "code" : "10000",
    "value" : "成都"
  }
}
```
### 修改
```
PUT /city/_doc/2
{
  "code":"10004",
  "value":"乐山"
}
```
## 使用结构化方式创建索引
```
/*使用结构化方式*/
put /city/
{
  "settings":{
    "number_of_shards":2,
    "number_of_replicas":3
  },
  "mappings":{
    "properties":{
      "code":{"type":"integer"},
      "value":{"type":"text"}
    }
  }
}
PUT /city/_doc/1
{
  "code":"10000",
  "value":"成都"
}
PUT /city/_doc/2
{
  "code":"10002",
  "value":"乐山"
}
POST /city/_doc/3
{
  "code":"10000",
  "value":"广州",
  "weather":"bad"
}
```
添加未定义的列不会出现异常，但是指定的数据类型与mapping设定的不相符就会报错
```
PUT /city/_doc/5
{
  "code":"华山",
  "value":"华山"
}
result：
{
  "error" : {
    "root_cause" : [
      {
        "type" : "mapper_parsing_exception",
        "reason" : "failed to parse field [code] of type [integer] in document with id '5'. Preview of field's value: '华山'"
      }
    ],
    "type" : "mapper_parsing_exception",
    "reason" : "failed to parse field [code] of type [integer] in document with id '5'. Preview of field's value: '华山'",
    "caused_by" : {
      "type" : "number_format_exception",
      "reason" : "For input string: \"华山\""
    }
  },
  "status" : 400
}

```

---

# 查询语句
+ query
+ match
+ match_all
## 查询全部
```
GET /city/_search
```
## 查询所有
```
GET /city/_search
{
    "query":{
        "match_all":{}
    }
}
```
## 查询指定id
```
GET /city/_doc/1
```
## 条件查询
使用match会启动分词

```
GET /city/_search
{
  "query":
  {
    "match": {
      "code":10000
    }
  }
}

GET /city/_search
{
  "query": 
  {
    "match": {
      "value":"成都人"
    }
  }
}

result:
{
  "took" : 4,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 1,
      "relation" : "eq"
    },
    "max_score" : 1.3862942,
    "hits" : [
      {
        "_index" : "city",
        "_type" : "_doc",
        "_id" : "1",
        "_score" : 1.3862942,
        "_source" : {
          "code" : "10000",
          "value" : "成都"
        }
      }
    ]
  }
}
```

## 分页

```
GET /city/_search
{
    "query":{
        "match_all":{}
    },
    "form":0,
    "size":1
}
```

## 排序
关键字sort
```
GET /city/_search
{
    "query":{
        "match":{"name":"成都"}
    },
    "sort":[
        {"code":{"order":"desc"}}
    ]
}
```

## filter
使用term不会启动分词
```
GET /city/_search
{
    "query":{
        "bool":{
            "filter":[
                {"term":{"name":成都}}
            ]
        }
    },
}
```
## 聚合
```
GET /employee/_search
{
    "query":{
        "match":{"name":"成都"}
    }
    "sort":[
        {"code":{"order":"desc"}}
    ]
    "aggs":{
        "group_bt_code":{
            "terms":{
                "field":"code"
            }
        }
    }
}
```