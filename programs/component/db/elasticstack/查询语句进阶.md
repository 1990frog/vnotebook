

# 执行计划
## 单字段
```
# 执行计划
GET /movie/_search
{
  "explain": true,
  "query": {
    "match": {
      "title": "Basketball"
    }
  }
}
```
结果分析
```
"_explanation":
{
  "value" : 8.280251,
  "description" : "weight(title:basketbal in 2390) [PerFieldSimilarity], result of:",
  "details" : [
    {
      "value" : 8.280251,
      "description" : "score(freq=1.0), computed as boost * idf * tf from:",
      "details" : [
        {
          "value" : 2.2,
          "description" : "boost",
          "details" : [ ]
        },
        {
          "value" : 8.00659,
          "description" : "idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:",
          "details" : [
            {
              "value" : 1,
              "description" : "n, number of documents containing term",
              "details" : [ ]
            },
            {
              "value" : 4500,
              "description" : "N, total number of documents with field",
              "details" : [ ]
            }
          ]
        },
        {
          "value" : 0.47008157,
          "description" : "tf, computed as freq / (freq + k1 * (1 - b + b * dl / avgdl)) from:",
          "details" : [
            {
              "value" : 1.0,
              "description" : "freq, occurrences of term within document",
              "details" : [ ]
            },
            {
              "value" : 1.2,
              "description" : "k1, term saturation parameter",
              "details" : [ ]
            },
            {
              "value" : 0.75,
              "description" : "b, length normalization parameter",
              "details" : [ ]
            },
            {
              "value" : 2.0,
              "description" : "dl, length of field",
              "details" : [ ]
            },
            {
              "value" : 2.1757777,
              "description" : "avgdl, average length of field",
              "details" : [ ]
            }
          ]
        }
      ]
    }
  ]
}
```
## 多字段
```
GET /movie/_search
{
  "explain": true,
  "query": {
    "multi_match": {
      "query": "basketball with cartoom aliens",
      "fields": ["title","overview"]
    }
  }
}
```

# 自定义权重
```
GET /movie/_search
{
  "query": {
    "multi_match": {
      "query": "basketball with cartoom aliens",
      "fields": ["title^10","overview"]
    }
  }
}
```

# 优化多字段查询
```
GET /movie/_search
{
  "query": {
    "multi_match": {
      "query": "basketball with cartoom aliens",
      "fields": ["title^10","overview"],
      "tie_breaker": 0.3
    }
  }
}
```

must not:必须都是false
should：其中只有一个为true即可，true越多则得分越高

```
GET /movie/_search
{
  "explain": true,
  "query": {
    "bool": {
      "should": [
        {"match": {"title": "basketball with cartoom aliens"}},
        {"match": {"overview": "basketball with cartoom aliens"}}
      ]
    }
  }
}
```

must会过滤掉单纯命中在一条上的记录


不同的multi_query其实是有不同的type
best_fields：默认的得分方式，取得最高的分数作为对应文档的对应分数，“最匹配模式”

```
GET /movie/_search
{
  "query": {
    "multi_match": {
      "query": "basketball with cartoom aliens",
      "fields": ["title","overview"]
    }
  }
}
```
等同于
```
GET /movie/_search
{
  "query": {
    "multi_match": {
      "query": "basketball with cartoom aliens",
      "fields": ["title","overview"],
      "type": "best_fields"
    }
  }
}
```

不同的multi_query其实是有不同的type
best_fields：默认的得分方式，取得最高的分数作为对应文档的对应分数，“最匹配模式”dis_max

```
GET /movie/_search
{
  "explain": true,
  "query": {
    "dis_max": {
      "queries": 
      [
        {"match": {"title": "basketball with cartoom aliens"}},
        {"match": {"overview": "basketball with cartoom aliens"}}
      ]
    }
  }
}
```

```
GET /movie/_validate/query?explain
{
  "query": {
    "multi_match": {
      "query": "basketball with cartoom aliens",
      "fields": ["title","overview"],
      "type": "best_fields"
    }
  }
}
```

```
GET /movie/_validate/query?explain
{
  "query": {
    "multi_match": {
      "query": "basketball with cartoom aliens",
      "fields": ["title^10","overview"],
      "type": "best_fields"
    }
  }
}
```

most_fields：考虑绝大多数（所有的）文档的字段得分相加，获得我们想要的结果

```
GET /movie/_search
{
  "explain": true,
  "query": {
    "multi_match": {
      "query": "basketball with cartoom aliens",
      "fields": ["title","overview"],
      "type": "most_fields"
    }
  }
}
```

```
GET /movie/_search
{
  "explain": true,
  "query": {
    "multi_match": {
      "query": "basketball with cartoom aliens",
      "fields": ["title^10","overview"],
      "type": "most_fields"
    }
  }
}

```



```
GET /movie/_search
{
  "explain": true,
  "query": {
    "multi_match": {
      "query": "basketball with cartoom aliens",
      "fields": ["title^10","overview^0.1"],
      "type": "most_fields"
    }
  }
}

```
cross_fields：以分词为单位计算栏位的总分，适用于词导向的匹配
```
GET /movie/_search
{
  "explain": true,
  "query": {
    "multi_match": {
      "query": "steve job",
      "fields": ["title","overview"],
      "type": "cross_fields"
    }
  }
}
```

```
GET /movie/_validate/query?explain
{
  "query": {
    "multi_match": {
      "query": "steve job",
      "fields": ["title","overview"],
      "type": "cross_fields"
    }
  }
}
```



---

query string
方便使用AND OR NOT
```
GET /movie/_search
{
  "query": {
    "query_string": {
      "fields": ["title"],
      "query": "steve AND jobs"
    }
  }
}
```


range类似between
```
GET /movie/_search
{
  "query": {
    "bool": {
      "filter": 
        [
          {"term":{"title":"steve"}},  
          {"term":{"cast.name":"gaspard"}},  
          {"range":{"relase_date":{"lte":"2015/01/01"}}},
          {"range":{"popularity":{"gte":"25"}}}
        ]
    }
  }
}
```

```
GET /movie/_search
{
  "query": {
    "bool": {
      "filter": 
        [
          {"term":{"title":"steve"}},  
          {"term":{"cast.name":"gaspard"}},  
          {"range":{"relase_date":{"lte":"2015/01/01"}}},
          {"range":{"popularity":{"gte":"25"}}}
        ]
    }
  },
  "sort": [
    {
      "popularity": {
        "order": "desc"
      }
    }
  ]
}
```



排序也可以打分

```
GET /movie/_search
{
  "query": {
    "bool": {
      "should": [
        {"match": {
          "title": "life"
        }}
      ], 
      "filter": [
        {"term":{"title":"steve"}},  
        {"term":{"cast.name":"gaspard"}},  
        {"range":{"relase_date":{"lte":"2015/01/01"}}},
        {"range":{"popularity":{"gte":"25"}}}
      ]
    }
  }
}

```

filter负责过滤
should负责打分